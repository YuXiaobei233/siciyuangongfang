<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½å›¾ç‰‡å‹ç¼©å™¨</title>
    <style>
        /* è‹¹æœé£æ ¼è®¾è®¡ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .upload-area {
            border: 2px dashed #007AFF;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin: 2rem 0;
            cursor: pointer;
            transition: 0.3s;
        }

        .upload-area:hover {
            background: #F2F8FF;
        }

        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 2rem 0;
            height: 500px; /* ç¨å¾®å¢åŠ é«˜åº¦ */
        }

        .preview-box {
            height: 420px; /* å›ºå®šé«˜åº¦ */
            display: flex;
            flex-direction: column;
            border: 1px solid #E5E5EA;
            border-radius: 8px;
            padding: 1rem;
            position: relative;
        }

        .preview-img {
            flex: 1;
            object-fit: contain; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
            background: #F8F8F8; /* æ·»åŠ èƒŒæ™¯è‰² */
            padding: 8px;
            max-width: 100%;
            height: auto;
            border-radius: 6px;
        }

        .size-info {
            margin: 12px 0 0;
            padding: 8px 12px;
            background: #F2F2F7;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quality-control {
            margin: 2rem 0;
            display: grid;
            gap: 1rem;
        }

        .download-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* æ–°å¢å®æ—¶å…³è”æ ·å¼ */
        .compression-info {
            display: flex;
            align-items: center;
            width: 100%;
        }

        .loading {
            color: #888;
            font-style: italic;
        }

        /* è°ƒæ•´å‹ç¼©ç‡æ˜¾ç¤º */
        .ratio-display {
            color: #34C759;
            font-size: 0.9rem;
            margin-left: 12px;
            white-space: nowrap;
        }

        /* ç»Ÿä¸€æ ‡é¢˜æ ·å¼ */
        .preview-box h3 {
            margin: 0 0 12px 0;
            font-size: 1.1rem;
            color: #1C1C1E;
        }

        /* æ·»åŠ åŠ è½½çŠ¶æ€æç¤º */
        #compressedInfo:empty::before {
            content: "è®¡ç®—ä¸­...";
            color: #888;
        }

        /* æ·»åŠ ç¼©ç•¥å›¾åˆ—è¡¨æ ·å¼ */
        .thumbnail-list {
            display: flex;
            gap: 8px;
            padding: 12px 0;
            overflow-x: auto;
            margin-bottom: 1rem;
        }

        .thumbnail-item {
            width: 80px;
            height: 80px;
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
            transition: 0.2s;
        }

        .thumbnail-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .thumbnail-item.active {
            border-color: #007AFF;
            box-shadow: 0 2px 8px rgba(0,122,255,0.2);
        }

        /* æ·»åŠ æŒ‰é’®ç»„æ ·å¼ */
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 8px;
        }

        .single-download {
            background: #007AFF; /* ä¿æŒåŸæœ‰è“è‰² */
        }

        .batch-download {
            background: #34C759; /* è‹¹æœé£æ ¼ç»¿è‰² */
        }

        /* è°ƒæ•´æŒ‰é’®å†…è¾¹è· */
        .download-btn {
            padding: 0.6rem 1rem;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <h1>æ™ºèƒ½å›¾ç‰‡å‹ç¼©å·¥å…·</h1>
    
    <!-- åœ¨é¢„è§ˆå¯¹æ¯”åŒºåŸŸä¸Šæ–¹æ·»åŠ ç¼©ç•¥å›¾åˆ—è¡¨ -->
    <div class="thumbnail-list" id="thumbnailList"></div>

    <!-- ä¿®æ”¹åŸæœ‰ä¸Šä¼ åŒºåŸŸæç¤º -->
    <div class="upload-area" id="dropZone">
        <p>æ‹–æ”¾æˆ–ç‚¹å‡»é€‰æ‹©å›¾ç‰‡ï¼ˆæ”¯æŒå¤šé€‰/æ‰¹é‡ä¸Šä¼ ï¼‰</p>
        <input type="file" id="fileInput" accept="image/*" hidden multiple>  <!-- æ·»åŠ multipleå±æ€§ -->
    </div>

    <!-- é¢„è§ˆå¯¹æ¯”åŒºåŸŸ -->
    <div class="preview-container">
        <div class="preview-box">
            <h3>åŸå§‹å›¾ç‰‡</h3>
            <img id="originalPreview" class="preview-img">
            <div class="size-info" id="originalInfo"></div>
        </div>
        <div class="preview-box">
            <h3>å‹ç¼©åå›¾ç‰‡</h3>
            <img id="compressedPreview" class="preview-img">
            <div class="compression-info">
                <div class="size-info" id="compressedInfo"></div>
                <div id="compressionRatio" class="ratio-display"></div>
            </div>
        </div>
    </div>

    <!-- å‹ç¼©æ§åˆ¶ -->
    <div class="quality-control">
        <div class="slider-container">
            <label>å‹ç¼©å¼ºåº¦ï¼š</label>
            <input type="range" id="qualityRange" min="0.1" max="1" step="0.1" value="0.3">
            <span id="qualityValue">80%</span>
        </div>
        
        <div class="button-group">
            <button class="download-btn single-download" id="downloadBtn">
                ä¸‹è½½å½“å‰
            </button>
            <button class="download-btn batch-download" id="batchDownloadBtn">
                æ‰¹é‡å¯¼å‡º
            </button>
        </div>
    </div>

    <script>
        let currentFile = null;
        let compressedBlob = null;
        
        // è·å–å…ƒç´ å¼•ç”¨
        const dropZone = document.getElementById('dropZone');

        // æ‹–æ”¾äº‹ä»¶å¤„ç†
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#F2F8FF';
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '';
            if(e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files);
        });

        // ç‚¹å‡»é€‰æ‹©æ–‡ä»¶
        dropZone.addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        // æ–°å¢å˜é‡å­˜å‚¨æ–‡ä»¶åˆ—è¡¨
        let fileList = [];
        let currentIndex = 0;

        // ä¿®æ”¹handleFileå¤„ç†å¤šæ–‡ä»¶
        function handleFile(files) {
            const validFiles = Array.from(files).filter(file => file.type.startsWith('image/'));
            
            if(validFiles.length === 0) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            fileList = [...fileList, ...validFiles];
            // ä¿®å¤é€‰ä¸­é€»è¾‘ï¼šå½“é¦–æ¬¡æ·»åŠ æ—¶é€‰ä¸­ç¬¬ä¸€ä¸ª
            currentIndex = fileList.length - validFiles.length; // å®šä½åˆ°ç¬¬ä¸€ä¸ªæ–°å¢æ–‡ä»¶
            currentFile = fileList[currentIndex]; // æ˜¾å¼è®¾ç½®å½“å‰æ–‡ä»¶
            updateThumbnails();
            showCurrentFile(); // ç¡®ä¿ç«‹å³è§¦å‘å‹ç¼©
        }

        // æ–°å¢ç¼©ç•¥å›¾åˆ—è¡¨æ›´æ–°å‡½æ•°
        function updateThumbnails() {
            const container = document.getElementById('thumbnailList');
            container.innerHTML = fileList.map((file, index) => `
                <div class="thumbnail-item ${index === currentIndex ? 'active' : ''}" 
                     data-index="${index}"
                     onclick="switchFile(${index})">
                    <img src="${URL.createObjectURL(file)}" alt="${file.name}">
                </div>
            `).join('');
        }

        // æ–°å¢æ–‡ä»¶åˆ‡æ¢å‡½æ•°
        function switchFile(index) {
            currentIndex = index;
            currentFile = fileList[index];
            updateThumbnails();
            showCurrentFile();
        }

        // ä¿®æ”¹åŸå§‹æ–‡ä»¶æ˜¾ç¤ºé€»è¾‘
        function showCurrentFile() {
            const file = fileList[currentIndex];
            const reader = new FileReader();
            reader.onload = e => {
                document.getElementById('originalPreview').src = e.target.result;
                document.getElementById('originalInfo').textContent = 
                    `åŸå§‹å°ºå¯¸: ${formatSize(file.size)}`;
            };
            reader.readAsDataURL(file);
            processCompression(file, parseFloat(document.getElementById('qualityRange').value));
        }

        // ä¿®æ”¹äº‹ä»¶ç›‘å¬å™¨å¤„ç†å¤šæ–‡ä»¶
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if(e.target.files.length > 0) handleFile(e.target.files);
        });

        // ä¿®æ”¹è´¨é‡è°ƒèŠ‚äº‹ä»¶å¤„ç†
        document.getElementById('qualityRange').addEventListener('input', function() {
            const rawValue = parseFloat(this.value);
            // æ˜¾ç¤ºå€¼åè½¬ï¼š0.1 â†’ 80%ï¼Œ1 â†’ 10% â†’ è½¬æ¢ä¸ºå‹ç¼©å¼ºåº¦ç™¾åˆ†æ¯”
            const displayPercent = 100 - Math.round((1.1 - rawValue) * 100);
            
            document.getElementById('qualityValue').textContent = `${displayPercent}%`;
            if (currentFile) processCompression(currentFile, 1.1 - rawValue);
        });

        // è°ƒæ•´åˆå§‹æ˜¾ç¤º
        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('qualityValue').textContent = "80%";
        });

        // æ ¸å¿ƒå‹ç¼©é€»è¾‘
        async function processCompression(file, quality) {
            document.getElementById('compressedInfo').textContent = 'å‹ç¼©ä¸­...';
            
            const img = await loadImage(file);
            const canvas = document.createElement('canvas');
            [canvas.width, canvas.height] = [img.width, img.height];
            
            canvas.getContext('2d').drawImage(img, 0, 0);
            
            // æ·»åŠ è´¨é‡é™åˆ¶ï¼ˆ0.1-1.0ï¼‰
            const clampedQuality = Math.min(Math.max(quality, 0.1), 1.0);
            
            canvas.toBlob(blob => {
                compressedBlob = blob;
                updateCompressionInfo(file.size, blob.size);
                document.getElementById('compressedPreview').src = URL.createObjectURL(blob);
            }, 'image/jpeg', clampedQuality);  // ä½¿ç”¨ä¿®æ­£åçš„è´¨é‡å€¼
        }

        // æ›´æ–°å‹ç¼©ä¿¡æ¯
        function updateCompressionInfo(originalSize, compressedSize) {
            const ratio = ((1 - compressedSize / originalSize) * 100).toFixed(1);
            document.getElementById('compressedInfo').textContent = 
                `å‹ç¼©å: ${formatSize(compressedSize)}`;
            document.getElementById('compressionRatio').textContent = 
                `èŠ‚çœ ${ratio}% (${formatSize(originalSize - compressedSize)})`;
        }

        // å·¥å…·å‡½æ•°
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        function formatSize(bytes) {
            const units = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            
            const i = Math.min(
                Math.floor(Math.log(bytes) / Math.log(1024)),
                units.length - 1
            );
            
            // ä¼˜åŒ–æ˜¾ç¤ºï¼šå½“å¤§äº1MBæ—¶ä¿ç•™ä¸¤ä½å°æ•°ï¼Œå¦åˆ™ä¿ç•™ä¸€ä½
            const size = bytes / Math.pow(1024, i);
            const decimals = i >= 2 ? 2 : 1; // MB/GBä¿ç•™ä¸¤ä½å°æ•°
            
            return `${size.toFixed(decimals)} ${units[i]}`;
        }

        // ä¿®æ”¹ä¸‹è½½åŠŸèƒ½ç»‘å®šå½“å‰æ–‡ä»¶
        document.getElementById('downloadBtn').addEventListener('click', () => {
            if(!compressedBlob || !fileList[currentIndex]) return;
            const url = URL.createObjectURL(compressedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `compressed_${fileList[currentIndex].name}`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // åœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ æ‰¹é‡å¯¼å‡ºåŠŸèƒ½
        document.getElementById('batchDownloadBtn').addEventListener('click', async () => {
            if(fileList.length === 0) return;
            
            const zip = new JSZip();
            const quality = parseFloat(document.getElementById('qualityRange').value);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const originalText = 'ğŸ—‚ æ‰¹é‡å¯¼å‡ºå…¨éƒ¨';
            document.getElementById('batchDownloadBtn').textContent = 'å‹ç¼©ä¸­...';
            
            try {
                // å¹¶è¡Œå¤„ç†æ‰€æœ‰æ–‡ä»¶
                await Promise.all(fileList.map(async (file, index) => {
                    const compressedBlob = await compressSingleFile(file, quality);
                    zip.file(`compressed_${file.name}`, compressedBlob);
                }));

                // ç”ŸæˆZIPæ–‡ä»¶
                const content = await zip.generateAsync({type:"blob"});
                const url = URL.createObjectURL(content);
                
                // è§¦å‘ä¸‹è½½
                const a = document.createElement('a');
                a.href = url;
                a.download = `compressed_images_${new Date().getTime()}.zip`;
                a.click();
                URL.revokeObjectURL(url);
            } finally {
                document.getElementById('batchDownloadBtn').textContent = originalText;
            }
        });

        // æå–ç‹¬ç«‹å‹ç¼©å‡½æ•°
        async function compressSingleFile(file, quality) {
            return new Promise(async (resolve) => {
                const img = await loadImage(file);
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                canvas.getContext('2d').drawImage(img, 0, 0);
                
                canvas.toBlob(blob => resolve(blob), 'image/jpeg', 
                    Math.min(Math.max(1.1 - quality, 0.1), 1.0)
                );
            });
        }
    </script>

    <!-- åœ¨é¡µé¢åº•éƒ¨æ·»åŠ JSZipåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</body>
</html> 